<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institutional Analytics - Ravi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --bg: #050505; --card: #0d0d0d; --text: #e0e0e0; --gold: #c5a059; --accent: #00c805; --danger: #ff3b3b; --border: #1a1a1a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold); padding-bottom: 15px; margin-bottom: 20px; }
        .btn-back { background: var(--gold); color: #000; padding: 10px 20px; border-radius: 4px; text-decoration: none; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; }
        
        .filters { display: flex; gap: 20px; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; }
        .filter-group { flex: 1; }
        label { display: block; font-size: 0.7rem; color: #666; margin-bottom: 8px; text-transform: uppercase; }
        select { background: #151515; color: #fff; border: 1px solid #252525; padding: 12px; border-radius: 6px; width: 100%; cursor: pointer; }

        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: var(--card); padding: 20px; border: 1px solid var(--border); border-radius: 12px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--gold); }

        #calendarArea { display: grid; gap: 25px; }
        .view-current { grid-template-columns: 1fr; max-width: 900px; margin: 0 auto; }
        .month-box { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--border); }
        .month-name { color: var(--gold); font-weight: bold; margin-bottom: 20px; border-left: 3px solid var(--gold); padding-left: 10px; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day { aspect-ratio: 1/1; background: #080808; border: 1px solid #151515; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; transition: 0.2s; }
        .day:hover { background: #111; border-color: var(--gold); }
        .green-day { background: rgba(0, 200, 5, 0.1) !important; border-color: var(--accent) !important; }
        .red-day { background: rgba(255, 59, 59, 0.1) !important; border-color: var(--danger) !important; }
        .d-num { font-size: 0.7rem; color: #444; position: absolute; top: 5px; left: 7px; }
        .d-pl { font-weight: bold; font-size: 0.9rem; }

        /* Floating Modal Styling */
        .modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); overflow-y: auto; }
        .modal-content { background: #0a0a0a; margin: 2% auto; padding: 30px; border: 1px solid var(--gold); width: 85%; max-width: 800px; border-radius: 10px; }
        .trade-card { background: #111; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--gold); cursor: pointer; }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 0.9rem; }
        .detail-label { color: var(--gold); font-weight: bold; }
        .screenshot-img { width: 100%; border-radius: 8px; margin-top: 15px; border: 1px solid #333; }
        .tag { background: #222; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; }
    </style>
</head>
<body>

<div class="header">
    <div style="letter-spacing: 3px; font-weight: 900; color: #fff;">ROBOTIC <span style="color:var(--gold)">MONITORING</span></div>
    <a href="index.html" class="btn-back">Terminal 1.0</a>
</div>

<div class="filters">
    <div class="filter-group">
        <label>Data Horizon</label>
        <select id="timeRange" onchange="loadData()">
            <option value="current">Current Month</option>
            <option value="3months">Last Quarter</option>
            <option value="1year">Annual View</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Account Portfolio</label>
        <select id="accFilter" onchange="loadData()">
            <option value="ALL">Consolidated (All Accounts)</option>
            <option value="A">Acc A</option><option value="B">Acc B</option><option value="C">Acc C</option><option value="D">Acc D</option><option value="E">Acc E</option>
        </select>
    </div>
</div>

<div class="stats-bar">
    <div class="stat-box"><div class="stat-label">Total Performance</div><div id="pnl" class="stat-val">$0.00</div></div>
    <div class="stat-box"><div class="stat-label">Execution Count</div><div id="trades" class="stat-val">0</div></div>
    <div class="stat-box"><div class="stat-label">Precision Rate</div><div id="wr" class="stat-val">0%</div></div>
    <div class="stat-box"><div class="stat-label">Green Sessions</div><div id="gDays" class="stat-val">0</div></div>
</div>

<div id="calendarArea"></div>

<div id="tradeModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="modalTitle" style="color:var(--gold); margin:0;">Daily Logs</h2>
            <button onclick="closeModal()" style="background:var(--danger); border:none; color:#fff; padding:5px 15px; cursor:pointer; border-radius:4px;">CLOSE</button>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<script>
    const history = JSON.parse(localStorage.getItem("aaravHist_v16")) || [];
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function loadData() {
        const range = document.getElementById("timeRange").value;
        const acc = document.getElementById("accFilter").value;
        const container = document.getElementById("calendarArea");
        container.innerHTML = "";
        if(range === 'current') container.className = "view-current"; else container.className = "view-year";

        let now = new Date();
        let displayMonths = [];
        if (range === "current") displayMonths.push({ m: now.getMonth(), y: now.getFullYear() });
        else { for(let i=11; i>=0; i--) { let d = new Date(now.getFullYear(), now.getMonth()-i, 1); displayMonths.push({m: d.getMonth(), y: d.getFullYear()}); } }

        renderDisplay(displayMonths, acc);
    }

    function renderDisplay(months, accFilter) {
        let tPL = 0, tTrades = 0, tWins = 0, tGreenDays = 0;
        months.forEach(obj => {
            const m = obj.m, y = obj.y;
            const monthDiv = document.createElement("div");
            monthDiv.className = "month-box";
            monthDiv.innerHTML = `<div class="month-name">${monthNames[m]} ${y}</div>`;
            const grid = document.createElement("div");
            grid.className = "cal-grid";
            ["S","M","T","W","T","F","S"].forEach(d => grid.innerHTML += `<div style="text-align:center; font-size:0.7rem; color:#444;">${d}</div>`);
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const dayTrades = history.filter(t => t.date === dateStr && (accFilter === "ALL" || t.acc === accFilter));
                const dayPL = dayTrades.reduce((s, t) => s + t.pl, 0);
                let cls = dayTrades.length > 0 ? (dayPL >= 0 ? "green-day" : "red-day") : "";
                if(dayPL > 0) tGreenDays++; tPL += dayPL; tTrades += dayTrades.length;
                tWins += dayTrades.filter(t => t.type === 'Target').length;

                const dayEl = document.createElement("div");
                dayEl.className = `day ${cls}`;
                dayEl.innerHTML = `<span class="d-num">${d}</span><span class="d-pl" style="color:${dayPL>=0?'var(--accent)':'var(--danger)'}">${dayPL ? '$'+Math.abs(dayPL).toFixed(0) : ''}</span>`;
                dayEl.onclick = () => openDayTrades(dateStr, dayTrades);
                grid.appendChild(dayEl);
            }
            monthDiv.appendChild(grid);
            document.getElementById("calendarArea").appendChild(monthDiv);
        });
        document.getElementById("pnl").innerText = `$${tPL.toFixed(2)}`;
        document.getElementById("trades").innerText = tTrades;
        document.getElementById("wr").innerText = tTrades ? ((tWins/tTrades)*100).toFixed(1) + "%" : "0%";
        document.getElementById("gDays").innerText = tGreenDays;
    }

    function openDayTrades(date, trades) {
        if(trades.length === 0) return;
        const modal = document.getElementById("tradeModal");
        const body = document.getElementById("modalBody");
        document.getElementById("modalTitle").innerText = `Log for ${date}`;
        body.innerHTML = trades.map((t, idx) => `
            <div class="trade-card" onclick="viewDeepDive(${history.indexOf(t)})">
                <div style="display:flex; justify-content:space-between;">
                    <b>TRADE ${idx + 1}: ${t.asset} (${t.acc})</b>
                    <span style="color:${t.pl>=0?'#00ff41':'#ff3131'}">$${t.pl.toFixed(2)}</span>
                </div>
                <div style="font-size:0.75rem; margin-top:5px; color:#888;">Type: ${t.type} | Grade: ${t.grade}</div>
            </div>
        `).join("");
        modal.style.display = "block";
    }

    function viewDeepDive(idx) {
        const t = history[idx];
        const body = document.getElementById("modalBody");
        body.innerHTML = `
            <button onclick="loadData(); document.getElementById('tradeModal').style.display='none';" style="background:#222; color:#fff; border:none; padding:8px; margin-bottom:15px; cursor:pointer;">‚Üê Back to List</button>
            <div id="printableArea">
                <h3 style="color:var(--gold); border-bottom:1px solid #333; padding-bottom:5px;">Institutional Deep-Dive: ${t.date}</h3>
                <div class="detail-row"><span class="detail-label">Asset / Account</span><span>${t.asset} / Account ${t.acc}</span></div>
                <div class="detail-row"><span class="detail-label">Outcome / P/L</span><span style="color:${t.pl>=0?'var(--accent)':'var(--danger)'}">${t.type} ($${t.pl})</span></div>
                <div class="detail-row"><span class="detail-label">Execution Flow</span><span>${t.flowStates ? Object.entries(t.flowStates).map(([k,v])=>`<span class="tag" style="color:${v==='G'?'#00ff41':'#ff3131'}">${k}</span>`).join("") : 'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">Bias Engine</span><span>${t.bias || 'Institutional Bias'}</span></div>
                <div class="detail-row"><span class="detail-label">Liquidity / Risk</span><span>${t.liqType || 'N/A'} / ${t.riskLots || 'N/A'}</span></div>
                <div style="margin-top:15px;">
                    <span class="detail-label">Psychology Review:</span>
                    <p style="background:#111; padding:10px; font-size:0.85rem; line-height:1.5;">${t.psy.join("<br>")}</p>
                </div>
                ${t.image ? `<img src="${t.image}" class="screenshot-img">` : '<p>No Screenshot Uploaded</p>'}
            </div>
            <button onclick="downloadTradePDF(${idx})" style="width:100%; background:var(--gold); color:#000; padding:15px; font-weight:bold; margin-top:20px; border:none; cursor:pointer;">DOWNLOAD COMPLETE TRADING JOURNAL (PDF)</button>
        `;
    }

    function downloadTradePDF(idx) {
        const t = history[idx];
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(5, 5, 5); doc.rect(0, 0, 210, 297, 'F');
        doc.setTextColor(197, 160, 89); doc.setFontSize(18); doc.text("INSTITUTIONAL TRADE JOURNAL", 14, 20);
        
        const rows = [
            ["Date", t.date], ["Account", t.acc], ["Asset", t.asset], ["Outcome", t.type],
            ["P/L", `$${t.pl}`], ["Grade", t.grade], ["Bias", t.bias || "N/A"],
            ["Scales", t.scale.join(", ")], ["Psychology", t.psy.join(" | ")]
        ];
        doc.autoTable({ startY: 30, body: rows, theme: 'grid', headStyles: {fillColor: [30, 30, 30]} });
        if (t.image) { doc.addPage(); doc.text("TRADE SCREENSHOT", 14, 20); doc.addImage(t.image, 'JPEG', 15, 30, 180, 120); }
        doc.save(`Journal_${t.date}_${t.acc}.pdf`);
    }

    function closeModal() { document.getElementById("tradeModal").style.display = "none"; }
    window.onclick = (e) => { if(e.target.className === 'modal') closeModal(); }
    loadData();
</script>
</body>
</html>