<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aarav Institutional Terminal v21 - Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #050505; --card: #111111; --text: #e0e0e0; --accent: #2e7d32; --border: #222; --danger: #d32f2f; --warning: #fbc02d; --gold: #c5a059; }
        body { margin: 0; font-family: 'Segoe UI', monospace; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 25px; text-align: center; border-bottom: 3px solid var(--gold); color: var(--gold); font-size: 1.6rem; letter-spacing: 2px; font-weight: bold; }
        .container { padding: 20px; max-width: 1350px; margin: auto; }
        .card { background: var(--card); padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border); }
        h2 { margin: 0 0 15px 0; border-left: 4px solid var(--gold); padding-left: 12px; font-size: 1rem; color: #fff; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 5px; background: #181818; color: #fff; border: 1px solid #333; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--accent); cursor: pointer; font-weight: bold; border: none; transition: 0.3s; }
        .balance-chip { background: #000; padding: 15px; border: 1px solid var(--gold); border-radius: 8px; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        th, td { border: 1px solid #222; padding: 12px; text-align: center; }
        th { background: #1a1a1a; color: var(--gold); }
        .security-bar { background: #1a0000; padding: 15px; border: 1px solid var(--danger); margin-bottom: 20px; border-radius: 8px; }
        .chart-container { height: 350px; margin-top: 20px; background: #000; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .check-item { display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-bottom: 1px solid #1a1a1a; }
        #postTradeSections { display: none; }
        .del-btn { background: #d32f2f; padding: 5px; font-size: 0.7rem; width: auto; }
    </style>
</head>
<body>

<header>Aarav Welcome Back best of luck! (Ravi)</header>

<div class="container">
    <div class="security-bar card">
        <label style="color:var(--danger); font-weight:bold;">PASSWORD REQUIRED FOR ALL ACTIONS (Delete/Save/Reset):</label>
        <input type="password" id="sysPass" placeholder="Enter Access Key!" style="border: 1px solid var(--danger);">
    </div>
    
    <div class="card">
        <h2>Combined Equity Curve (Total Portfolio)</h2>
        <div class="grid" id="balanceDisplay"></div>
        <div class="chart-container"><canvas id="equityLineChart"></canvas></div>
    </div>

    <div class="card">
        <h2>1. Trading Control Panel</h2>
        <div class="grid">
            <div><label>Date</label><input type="date" id="tradeDate"></div>
            <div><label>Trading Day</label><select id="daySelect" onchange="updateAccount()"><option value="">--Select--</option><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option></select></div>
            <div><label>Trade Slot</label><select id="slotSelect" onchange="updateAccount()"><option value="">--Select--</option><option value="1">Trade 1</option><option value="2">Trade 2</option></select></div>
            <div><label>Direct Account</label><select id="directAccount" onchange="updateAccount()"><option value="">--None--</option><option value="D">Account D</option><option value="E">Account E</option></select></div>
        </div>
        <div id="accountInfo" style="margin-top:10px; color:var(--gold);">Select slot to see account...</div>
    </div>

    <div class="card">
        <h2>2. Permission Matrix (Bias Engine)</h2>
        <div class="grid">
            <label class="check-item"><input type="checkbox" class="perm" id="support"> Support</label>
            <label class="check-item"><input type="checkbox" class="perm" id="resistance"> Resistance</label>
            <label class="check-item"><input type="checkbox" class="perm" id="demand"> Demand</label>
            <label class="check-item"><input type="checkbox" class="perm" id="supply"> Supply</label>
            <label class="check-item"><input type="checkbox" class="perm" id="discount"> Discount</label>
            <label class="check-item"><input type="checkbox" class="perm" id="premium"> Premium</label>
        </div>
        <div id="biasDisplay" style="padding:15px; text-align:center; margin-top:10px; font-weight:bold;">NEUTRAL BIAS</div>
    </div>

    <div class="card">
        <h2>3. Institutional Execution Flow</h2>
        <div class="grid">
            <label class="check-item"><input type="checkbox" class="flow"> Sleep (7h+)</label>
            <label class="check-item"><input type="checkbox" class="flow"> No Revenge/Fear</label>
            <label class="check-item"><input type="checkbox" class="flow"> Desk Ready</label>
            <label class="check-item"><input type="checkbox" class="flow"> HTF Location</label>
            <label class="check-item"><input type="checkbox" class="flow"> Single Side</label>
            <label class="check-item"><input type="checkbox" class="flow"> No Mid-Range</label>
            <label class="check-item"><input type="checkbox" class="flow"> Clear Range</label>
            <label class="check-item"><input type="checkbox" class="flow"> LTF Confirm</label>
            <label class="check-item"><input type="checkbox" class="flow"> Risk Locked</label>
            <label class="check-item"><input type="checkbox" class="flow"> Liquidity Swept</label>
        </div>
        <button id="executeBtn" disabled onclick="revealSections()" style="margin-top:20px; background:var(--gold); color:#000;">AUTHORIZE ENTRY</button>
    </div>

    <div id="postTradeSections">
        <div class="card">
            <h2>4. Parameters & Profit Booking</h2>
            <div class="grid">
                <div><label>Entry Price</label><input id="entryPrice" placeholder="0.0000"></div>
                <div><label>Exit Price</label><input id="exitPrice" placeholder="0.0000"></div>
                <div><label>Entry Time</label><input type="time" id="entryTime"></div>
                <div><label>Exit Time</label><input type="time" id="exitTime"></div>
                <div><label>Net P/L ($)</label><input id="netPL" type="number" step="0.01"></div>
                <div><label>Outcome</label><select id="outcome"><option>Target</option><option>Stop Loss</option><option>Break Even</option></select></div>
                <div><label>Grade</label><select id="gradeSelect"><option>A+</option><option>A</option><option>B+</option><option>B</option><option>C</option><option>D</option></select></div>
            </div>
            <div class="grid" style="margin-top:10px;">
                <label class="check-item"><input type="checkbox" class="scale" id="s1"> 1:2 (40%)</label>
                <label class="check-item"><input type="checkbox" class="scale" id="s2"> 1:3 (30%)</label>
                <label class="check-item"><input type="checkbox" class="scale" id="s3"> Runner (30%)</label>
            </div>
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px;">
                <label>Violation Categories</label>
                <div style="display:flex; gap:10px;">
                    <select id="vSelect">
                        <option value="None">None</option>
                        <option>Mid-session risk alteration</option>
                        <option>Emotional account switching</option>
                        <option>Forced/revenge trade</option>
                        <option>Intuition entry</option>
                        <option>Exceeding 2 trades/day</option>
                        <option>Missing screenshot</option>
                        <option>Platform access without checklist</option>
                    </select>
                    <button onclick="addVio()" style="width:100px;">Add</button>
                </div>
                <ul id="vList" style="color:var(--danger); font-size:0.8rem;"></ul>
            </div>
        </div>

        <div class="card">
            <h2>5. Institutional Portal (Expectancy)</h2>
            <table id="portalTable">
                <thead><tr><th>Acc</th><th>Trades</th><th>Wins</th><th>Net P/L</th><th>WR %</th><th>Balance</th></tr></thead>
                <tbody id="portalBody"></tbody>
            </table>
        </div>

        <div class="card">
            <h2>6. Trade History Log (Selective Delete)</h2>
            <div style="overflow-x:auto;">
                <table id="historyTable">
                    <thead><tr><th>Date</th><th>Acc</th><th>Outcome</th><th>P/L</th><th>Price</th><th>Grade</th><th>Action</th></tr></thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
            <button onclick="downloadHistoryPDF()" style="margin-top:10px; background:#444; width:200px;">Download History Log</button>
        </div>

        <div class="card" style="border:1px solid var(--danger);">
            <h2 style="color:var(--danger);">7. Shutdown Protocol</h2>
            <div class="grid">
                <label class="check-item"><input type="checkbox" class="shut"> Positions Closed</label>
                <label class="check-item"><input type="checkbox" class="shut"> MT5 Closed</label>
                <label class="check-item"><input type="checkbox" class="shut"> App Uninstalled</label>
                <label class="check-item"><input type="checkbox" class="shut"> Laptop Shut Down</label>
            </div>
        </div>

        <div class="card">
            <h2>8. Final Sign-Off</h2>
            <textarea id="lesson" placeholder="One master lesson from this session..."></textarea>
            <input type="file" id="screenshot" style="margin-top:10px;">
            <button onclick="handleSaveAction()" style="background:var(--danger); height:60px; margin-top:20px; color:#fff;">LOCK DATA & DOWNLOAD SESSION PDF</button>
        </div>
    </div>

    <div class="card">
        <h2>System Reset</h2>
        <select id="resetTarget" style="width:200px;"><option value="A">Acc A</option><option value="B">Acc B</option><option value="C">Acc C</option><option value="D">Acc D</option><option value="E">Acc E</option></select>
        <button onclick="handleResetBalance()" style="background:#333; width:150px;">Reset Account</button>
    </div>
</div>

<script>
    const PASS = "Akanksha@2011";
    const config = { A:10000, B:25000, C:50000, D:25000, E:50000 };
    const risks = { A:0.0035, B:0.0035, C:0.0035, D:0.005, E:0.006 };
    
    let db = JSON.parse(localStorage.getItem("aaravDB_v16")) || {};
    let history = JSON.parse(localStorage.getItem("aaravHist_v16")) || [];
    let equityPoints = JSON.parse(localStorage.getItem("aaravEquity_v16")) || [160000];
    let violations = [];
    let currentAcc = "";
    let chartInstance = null;

    function initDB() {
        Object.keys(config).forEach(k => { if(!db[k]) db[k] = { bal: config[k], trades: 0, wins: 0, net: 0 }; });
        renderAll();
    }

    function renderAll() {
        localStorage.setItem("aaravDB_v16", JSON.stringify(db));
        localStorage.setItem("aaravHist_v16", JSON.stringify(history));
        localStorage.setItem("aaravEquity_v16", JSON.stringify(equityPoints));
        
        const display = document.getElementById("balanceDisplay");
        const portal = document.getElementById("portalBody");
        const histBody = document.getElementById("historyBody");
        display.innerHTML = ""; portal.innerHTML = ""; histBody.innerHTML = "";
        
        let tT=0, tW=0, tN=0, tB=0;
        Object.keys(db).forEach(k => {
            let wr = db[k].trades ? ((db[k].wins/db[k].trades)*100).toFixed(1) : 0;
            display.innerHTML += `<div class="balance-chip">${k}: <b>$${db[k].bal.toFixed(2)}</b></div>`;
            portal.innerHTML += `<tr><td>Acc ${k}</td><td>${db[k].trades}</td><td>${db[k].wins}</td><td>$${db[k].net.toFixed(2)}</td><td>${wr}%</td><td>$${db[k].bal.toFixed(2)}</td></tr>`;
            tT+=db[k].trades; tW+=db[k].wins; tN+=db[k].net; tB+=db[k].bal;
        });

        // Combined Total Row
        portal.innerHTML += `<tr style="background:#1a1a1a; font-weight:bold; color:var(--gold); border-top:2px solid var(--gold);"><td>TOTAL</td><td>${tT}</td><td>${tW}</td><td>$${tN.toFixed(2)}</td><td>${tT?((tW/tT)*100).toFixed(1):0}%</td><td>$${tB.toFixed(2)}</td></tr>`;

        history.forEach((h, idx) => {
            histBody.innerHTML += `<tr><td>${h.date}</td><td>${h.acc}</td><td>${h.type}</td><td>$${h.pl}</td><td>${h.entry}</td><td>${h.grade || 'N/A'}</td><td><button class="del-btn" onclick="deleteTrade(${idx})">DEL</button></td></tr>`;
        });
        updateChart();
    }

    function updateChart() {
        const ctx = document.getElementById('equityLineChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: equityPoints.map((_, i) => i), datasets: [{ label: 'Total Equity', data: equityPoints, borderColor: '#c5a059', fill: true, backgroundColor: 'rgba(197,160,89,0.1)', tension:0.3 }] },
            options: { maintainAspectRatio: false }
        });
    }

    function updateAccount() {
        let day=document.getElementById("daySelect").value, slot=document.getElementById("slotSelect").value, direct=document.getElementById("directAccount").value;
        if(direct) currentAcc = direct;
        else if(day && slot) {
            const map = { Monday:["A","C"], Tuesday:["B","A"], Wednesday:["C","B"], Thursday:["A","B"], Friday:["B","C"] };
            currentAcc = map[day][slot-1];
        }
        if(currentAcc) document.getElementById("accountInfo").innerHTML = `<b>ACTIVE: ACCOUNT ${currentAcc}</b> | Cap: $${db[currentAcc].bal.toFixed(2)} | Risk: $${(db[currentAcc].bal * risks[currentAcc]).toFixed(2)}`;
    }

    document.querySelectorAll(".flow").forEach(el => el.addEventListener("change", () => {
        document.getElementById("executeBtn").disabled = !Array.from(document.querySelectorAll(".flow")).every(i => i.checked);
    }));

    function revealSections() { document.getElementById("postTradeSections").style.display = "block"; }

    function addVio() {
        let v = document.getElementById("vSelect").value;
        if(v!=="None" && !violations.includes(v)) { violations.push(v); let li=document.createElement("li"); li.innerText=v; document.getElementById("vList").appendChild(li); }
    }

    function deleteTrade(idx) {
        if(document.getElementById("sysPass").value !== PASS) return alert("Wrong Password!");
        if(confirm("Delete this trade?")) {
            let t = history[idx];
            db[t.acc].trades--;
            if(t.type==="Target") db[t.acc].wins--;
            db[t.acc].bal -= t.pl;
            db[t.acc].net -= t.pl;
            history.splice(idx, 1);
            equityPoints.pop();
            renderAll();
        }
    }

    function handleSaveAction() {
        if(document.getElementById("sysPass").value !== PASS) return alert("Wrong Password!");
        let pl = parseFloat(document.getElementById("netPL").value) || 0;
        let out = document.getElementById("outcome").value;
        let grade = document.getElementById("gradeSelect").value;

        db[currentAcc].trades += 1;
        if(out === "Target") db[currentAcc].wins += 1;
        let finalPL = (out==="Stop Loss" ? -Math.abs(pl) : pl);
        db[currentAcc].net += finalPL;
        db[currentAcc].bal += finalPL;

        history.push({ date: document.getElementById("tradeDate").value, acc: currentAcc, type: out, pl: finalPL, entry: document.getElementById("entryPrice").value, grade: grade });
        equityPoints.push(Object.values(db).reduce((s, a) => s + a.bal, 0));

        renderAll();
        generateFullPDF(pl, out, grade);
        alert("Session Locked.");
        location.reload();
    }

    function generateFullPDF(pl, out, grade) {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF();
        doc.text("AARAV INSTITUTIONAL SESSION REPORT", 10, 15);
        doc.setFontSize(10);
        doc.text(`Date: ${document.getElementById("tradeDate").value} | Acc: ${currentAcc} | Outcome: ${out} | Grade: ${grade}`, 10, 25);
        doc.text(`Entry Price: ${document.getElementById("entryPrice").value} | Exit Price: ${document.getElementById("exitPrice").value} | P/L: $${pl}`, 10, 32);
        doc.text(`Violations: ${violations.join(", ") || "None"}`, 10, 39);
        doc.text(`Lesson: ${document.getElementById("lesson").value}`, 10, 46);
        doc.autoTable({ startY: 55, head: [['Acc','Trades','Wins','Net','Balance']], body: Object.keys(db).map(k => [k, db[k].trades, db[k].wins, db[k].net.toFixed(2), db[k].bal.toFixed(2)]) });
        doc.save(`Session_${Date.now()}.pdf`);
    }

    function downloadHistoryPDF() {
        if(document.getElementById("sysPass").value !== PASS) return alert("Wrong Password!");
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF();
        doc.text("MASTER TRADE HISTORY LOG", 10, 10);
        doc.autoTable({ startY: 20, head: [['Date','Acc','Outcome','P/L','Price','Grade']], body: history.map(h => [h.date, h.acc, h.type, h.pl, h.entry, h.grade]) });
        doc.save("Trade_History_Master.pdf");
    }

    function handleResetBalance() {
        if(document.getElementById("sysPass").value !== PASS) return alert("Wrong Password!");
        let t = document.getElementById("resetTarget").value;
        db[t] = { bal: config[t], trades: 0, wins: 0, net: 0 };
        renderAll();
    }

    document.querySelectorAll(".perm").forEach(el => el.addEventListener("change", () => {
        let s=document.getElementById("support").checked, d=document.getElementById("demand").checked, dis=document.getElementById("discount").checked;
        let box = document.getElementById("biasDisplay");
        if(d && dis) { box.innerText="BULLISH BIAS"; box.style.color="#4caf50"; }
        else { box.innerText="NEUTRAL/BEARISH"; box.style.color="#f44336"; }
    }));

    initDB();
</script>
</body>
</html>