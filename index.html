<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aarav Institutional Terminal v22 - Final Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #050505; --card: #111111; --text: #e0e0e0; --accent: #2e7d32; --border: #222; --danger: #d32f2f; --warning: #fbc02d; --gold: #c5a059; }
        body { margin: 0; font-family: 'Segoe UI', monospace; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: #000; padding: 25px; text-align: center; border-bottom: 3px solid var(--gold); color: var(--gold); font-size: 1.6rem; letter-spacing: 2px; font-weight: bold; }
        .chart-container { 
    background: radial-gradient(circle, #0a0a0a 0%, #000 100%); 
    border: 1px solid #222; 
    border-radius: 8px; 
    padding: 10px; 
}
        .container { padding: 20px; max-width: 1350px; margin: auto; }
        .card { background: var(--card); padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border); }
        h2 { margin: 0 0 15px 0; border-left: 4px solid var(--gold); padding-left: 12px; font-size: 1rem; color: #fff; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 5px; background: #181818; color: #fff; border: 1px solid #333; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--accent); cursor: pointer; font-weight: bold; border: none; transition: 0.3s; }
        .balance-chip { background: #000; padding: 15px; border: 1px solid var(--gold); border-radius: 8px; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        th, td { border: 1px solid #222; padding: 12px; text-align: center; }
        th { background: #1a1a1a; color: var(--gold); }
        tfoot tr { background: #1a1a1a; font-weight: bold; color: var(--gold); }
        .security-bar { background: #1a0000; padding: 15px; border: 1px solid var(--danger); margin-bottom: 20px; border-radius: 8px; }
        .chart-container { height: 350px; margin-top: 20px; background: #000; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .check-item { display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-bottom: 1px solid #1a1a1a; }
        #postTradeSections { display: none; }
        .del-btn { background: #d32f2f; padding: 5px; font-size: 0.7rem; width: auto; margin: 2px; }
        .view-btn { background: #2196f3; padding: 5px; font-size: 0.7rem; width: auto; margin: 2px; }
        .risk-active { background: #1b5e20 !important; border-color: #4caf50 !important; }
        .vio-tag { background: #311b1b; color: #ff5252; padding: 4px 8px; border-radius: 4px; border: 1px solid #d32f2f; margin: 2px; font-size: 0.7rem; display: inline-block; }
        .modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); overflow-y: auto; }
        .modal-content { background: #111; margin: 2% auto; padding: 30px; border: 1px solid var(--gold); width: 85%; border-radius: 10px; position: relative; }
        /* EXECUTION FLOW - TRADE 2 REPLICA DESIGN */
.exec-card-locked {
    background: #000 !important;
    border: 1px solid #333 !important;
    border-left: 4px solid #ff5252 !important; /* Side border like Trade 2 */
    box-shadow: 0 4px 15px rgba(255, 82, 82, 0.1) !important;
}

.exec-card-ready {
    background: #000 !important;
    border: 1px solid #00ff41 !important;
    border-left: 4px solid #00ff41 !important;
    box-shadow: 0 0 25px rgba(0, 255, 65, 0.2) !important;
}

.binary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Ek line mein do item */
    gap: 8px;
    margin-bottom: 15px;
}

.bin-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #0a0a0a;
    padding: 10px;
    border: 1px solid #1a1a1a;
    border-radius: 5px;
}

.bin-text { font-size: 0.75rem; color: #c5a059; font-weight: bold; }

.t-btn {
    width: 32px; height: 26px; border: 1px solid #333;
    background: #111; cursor: pointer; font-size: 0.7rem; border-radius: 3px;
    font-weight: bold;
}
.t-btn.g-off { color: #00ff41; }
.t-btn.r-off { color: #ff5252; }
.t-btn.g-on { background: #00ff41 !important; color: #000 !important; box-shadow: 0 0 10px #00ff41; border: none; }
.t-btn.r-on { background: #ff5252 !important; color: #fff !important; box-shadow: 0 0 10px #ff5252; border: none; }
    </style>
</head>
<body>

<button onclick="window.location.href='monitoring.html'" 
    style="background: linear-gradient(135deg, var(--gold), #8a6d3b); color: #000; border: none; padding: 10px 20px; border-radius: 4px; font-weight: 900; font-size: 0.75rem; cursor: pointer; margin-left: 20px; box-shadow: 0 4px 15px rgba(197, 160, 89, 0.2); text-transform: uppercase;">
    üìä Institutional Analytics Portal
</button>

<div class="container">
    <div class="security-bar card">
        <label style="color:var(--danger); font-weight:bold;">PASSWORD REQUIRED FOR ALL ACTIONS:</label>
        <input type="password" id="sysPass" placeholder="Enter Access Key!" style="border: 1px solid var(--danger);">
    </div>
    
    <div class="card">
        <h2>Combined Equity Curve (Mon-Fri)</h2>
        <div class="grid" id="balanceDisplay"></div>
        <div class="card">
    <div class="card" style="position: relative;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2>1. Institutional Equity Pulse</h2>
        <div style="display: flex; gap: 8px;">
            <button onclick="changeChartRange(7)" style="padding: 4px 12px; font-size: 0.7rem; background: #1a1a1a; border: 1px solid #333; width: auto;">Weekly</button>
            <button onclick="changeChartRange(30)" style="padding: 4px 12px; font-size: 0.7rem; background: #1a1a1a; border: 1px solid #333; width: auto;">Monthly</button>
        </div>
    </div>
    
    <div class="chart-container" style="position: relative; height:380px; background: #000; overflow: hidden;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(0, 102, 204, 0.15); font-size: 4rem; font-weight: bold; pointer-events: none; letter-spacing: 10px; z-index: 1;"></div>
        
        <div id="innerWinRate" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; border: 1px solid #222; z-index: 2; font-family: monospace;">
            <span style="color: #888; font-size: 0.7rem;">WIN RATE:</span><br>
            <span id="chartWR" style="color: var(--gold); font-size: 1.2rem; font-weight: bold;">0%</span>
        </div>

        <canvas id="equityLineChart" style="z-index: 3; position: relative;"></canvas>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; padding: 0 10px;">
    
    <div id="cardT1" style="background: #000; padding: 20px; border-radius: 12px; border-left: 5px solid #00d4ff; transition: 0.5s; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        <div style="font-size: 0.75rem; color: #00d4ff; font-weight: bold; letter-spacing: 1px; margin-bottom: 10px;">TRADE 1</div>
        <div id="timerT1" style="font-size: 1.3rem; font-weight: bold; font-family: 'Courier New', monospace; color: #fff;">00h 00m 00s</div>
    </div>
    
    <div id="cardT2" style="background: #000; padding: 20px; border-radius: 12px; border-left: 5px solid #bc13fe; transition: 0.5s; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        <div style="font-size: 0.75rem; color: #bc13fe; font-weight: bold; letter-spacing: 1px; margin-bottom: 10px;">TRADE 2</div>
        <div id="timerT2" style="font-size: 1.3rem; font-weight: bold; font-family: 'Courier New', monospace; color: #fff;">00h 00m 00s</div>
    </div>
    
</div>

    <div class="card">
    <h2>1. Trading Control Panel</h2>
    <div class="grid">
        <div><label>Date</label><input type="date" id="tradeDate"></div>
        <div><label>Asset</label>
            <select id="assetSelect" onchange="updateAccount()">
                <option value="XAUUSD">XAUUSD (Gold)</option>
                <option value="EURUSD">EURUSD</option>
                <option value="GBPUSD">GBPUSD</option>
                <option value="BTCUSD">BTCUSD</option>
            </select>
        </div>
        <div><label>Trading Day</label>
            <select id="daySelect" onchange="updateAccount()">
                <option value="">--Select--</option><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option>
            </select>
        </div>
        <div><label>Trade Slot</label>
            <select id="slotSelect" onchange="updateAccount()">
                <option value="">--Select--</option><option value="1">Trade 1</option><option value="2">Trade 2</option>
            </select>
        </div>
        <div><label>Direct Account</label>
            <select id="directAccount" onchange="updateAccount()">
                <option value="">--None--</option><option value="D">Account D</option><option value="E">Account E</option>
            </select>
        </div>
    </div>
    <div id="accountInfo" style="margin-top:15px; padding:10px; background:#1a1a1a; border:1px solid var(--gold); border-radius:5px; color:var(--gold); font-weight: bold; line-height: 1.6;">
        Select options to calculate risk...
    </div>
</div>

    <div class="card">
        <h2>2. Permission Matrix (Bias Engine)</h2>
        <div class="grid">
            <label class="check-item"><input type="checkbox" class="perm" id="support"> Support</label>
            <label class="check-item"><input type="checkbox" class="perm" id="resistance"> Resistance</label>
            <label class="check-item"><input type="checkbox" class="perm" id="demand"> Demand</label>
            <label class="check-item"><input type="checkbox" class="perm" id="supply"> Supply</label>
            <label class="check-item"><input type="checkbox" class="perm" id="discount"> Discount</label>
            <label class="check-item"><input type="checkbox" class="perm" id="premium"> Premium</label>
        </div>
        <div id="biasDisplay" style="padding:15px; text-align:center; margin-top:10px; font-weight:bold; border: 1px solid #222;">NEUTRAL BIAS</div>
    </div>

   <div class="card exec-card-locked" id="flowCard">
    <h2 id="flowTitle" style="color:#ff5252; font-size: 1.1rem; letter-spacing: 1px;">3. Institutional Execution Flow</h2>
    
    <div id="binaryChecklist" class="binary-grid"></div>

    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid #222; padding-top: 15px;">
        <div style="background:#000; padding:10px; border:1px solid #333; border-radius:5px;">
            <label style="font-size:0.65rem; color:#c5a059; display:block; margin-bottom:5px;">RISK QTY (MANDATORY)</label>
            <input type="text" id="riskQty" oninput="updateFlowStatus()" placeholder="Lots..." 
                   style="background:transparent; border:none; border-bottom:1px solid #444; color:#fff; width:90%; outline:none;">
        </div>
        <div style="background:#000; padding:10px; border:1px solid #333; border-radius:5px;">
            <label style="font-size:0.65rem; color:#c5a059; display:block; margin-bottom:5px;">LIQUIDITY (MANDATORY)</label>
            <select id="liqType" onchange="updateFlowStatus()" 
                    style="background:transparent; border:none; color:#fff; width:100%; outline:none; cursor:pointer;">
                <option value="">Select...</option>
                <option value="Minor">Minor Liquidity</option>
                <option value="Major">Major Liquidity</option>
            </select>
        </div>
    </div>
    
    <button id="executeBtn" disabled onclick="revealSections()" 
        style="margin-top:20px; background:#1a1a1a; color:#444; border:1px solid #333; height:50px; width:100%; font-weight:900; letter-spacing:2px; transition: 0.3s;">
        AUTHORIZE ENTRY (LOCKED)
    </button>
</div>

    <div id="postTradeSections">
        <div class="card">
            <h2>4. Parameters & Profit Booking Scale</h2>
            <div class="grid" style="margin-bottom:15px; grid-template-columns: repeat(3, 1fr);">
                <label class="check-item"><input type="checkbox" class="scale" value="1:2 (40%)"> 1:2 (40%)</label>
                <label class="check-item"><input type="checkbox" class="scale" value="1:3 (30%)"> 1:3 (30%)</label>
                <label class="check-item"><input type="checkbox" class="scale" value="Runner (30%)"> Runner (30%)</label>
            </div>
            <div class="grid">
                <div><label>Position</label><select id="assetSelect"><option>LONG</option><option>SHORT</option><option></option><option></option></select></div>
                <div><label>Entry Price</label><input id="entryPrice" placeholder="0.0000"></div>
                <div><label>Exit Price</label><input id="exitPrice" placeholder="0.0000"></div>
                <div><label>Outcome</label><select id="outcome"><option>Target</option><option>Stop Loss</option><option>Break Even</option></select></div>
                <div><label>Net P/L ($)</label><input id="netPL" type="number" step="0.01"></div>
                <div><label>Grade</label><select id="gradeSelect"><option>A+</option><option>A</option><option>B+</option><option>B</option><option>C</option></select></div>
            </div>

            <div style="margin-top:20px;">
                <label>Violation Categories</label>
                <div style="display:flex; gap:10px;">
                    <select id="vSelect" style="flex:1;">
                        <option value="None">None</option>
                        <option>Mid-session risk alteration</option>
                        <option>Emotional account switching</option>
                        <option>Forced/revenge trade</option>
                        <option>Intuition entry</option>
                        <option>Exceeding 2 trades/day</option>
                        <option>Missing screenshot</option>
                        <option>Platform access without checklist</option>
                    </select>
                    <button onclick="addVio()" style="width:100px; background:var(--accent);">Add</button>
                </div>
                <div id="vListDisplay" style="margin-top:10px;"></div>
            </div>
        </div>

        <div class="card">
            <h2>5. Institutional Portal (Expectancy)</h2>
            <table id="portalTable">
                <thead><tr><th>Acc</th><th>Trades</th><th>Wins</th><th>Net P/L</th><th>WR %</th><th>Balance</th></tr></thead>
                <tbody id="portalBody"></tbody>
                <tfoot id="portalFoot"></tfoot>
            </table>
        </div>

        <div class="card">
            <h2>6. Institutional Psychology Review</h2>
            <div class="grid" style="grid-template-columns: 1fr;">
                <div><label>Did I trade my plan or emotion?</label><textarea id="psy1" rows="1"></textarea></div>
                <div><label>Was my setup institutional?</label><textarea id="psy2" rows="1"></textarea></div>
                <div><label>Did I maintain patience before entry?</label><textarea id="psy3" rows="1"></textarea></div>
                <div><label>How was my focus and neutrality?</label><textarea id="psy4" rows="1"></textarea></div>
                <div><label>What emotional bias affected me most?</label><textarea id="psy5" rows="1"></textarea></div>
                <div><label>One key lesson for next session:</label><textarea id="lesson" rows="2"></textarea></div>
            </div>
        </div>
        
        <label>Upload Trade Screenshot</label>
            <input type="file" id="screenshotInput" accept="image/*" style="margin-bottom:20px;">
            <button onclick="handleSaveAction()" style="background:var(--danger); height:60px; color:#fff;">LOCK DATA & FINALIZE SESSION</button>
        </div>
    </div>

    <div class="card">
        <h2 style="color:var(--danger); font-weight:bold;">7. Shutdown Protocol</h2>
        <div class="grid">
            <label class="check-item"><input type="checkbox" id="checkPositions"> Positions Closed</label>
            <label class="check-item"><input type="checkbox" id="checkMT5"> MT5 Closed</label>
            <label class="check-item"><input type="checkbox" id="checkApp"> App Uninstalled</label>
            <label class="check-item"><input type="checkbox" id="checkLaptop"> Laptop Shut Down</label>
        </div>
    </div>

    <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>8. Trade History Log</h2>
        <button onclick="downloadHistoryPDF()" style="background:var(--gold); color:#000; width:auto; padding:5px 15px; font-size:0.8rem;">Download Master History (PDF)</button>
    </div>
    <div class="grid" style="margin-bottom:15px; grid-template-columns: 1fr 1fr auto;">
        <div><label>From</label><input type="date" id="histFrom"></div>
        <div><label>To</label><input type="date" id="histTo"></div>
        <div style="display:flex; align-items:flex-end;"><button onclick="filterHistory()" style="background:#222; border:1px solid #444; width:80px;">Filter</button></div>
    </div>
    <table id="historyTable">
        <thead><tr><th>Date</th><th>Acc</th><th>Outcome</th><th>P/L</th><th>Grade</th><th>Action</th></tr></thead>
        <tbody id="historyBody"></tbody>
    </table>
</div>

<div id="viewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; overflow-y:auto;">
    <div style="background:#111; margin:5% auto; padding:25px; border:2px solid var(--gold); max-width:700px; border-radius:12px; position:relative;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px;">
            <h1 style="color:var(--gold); margin:0; font-size:1.2rem;">INSTITUTIONAL DEEP-DIVE</h1>
            <button onclick="closeModal()" style="background:var(--danger); width:35px; color:#fff; cursor:pointer;">X</button>
        </div>
        <div id="modalData" style="margin-top:20px; line-height:1.8;"></div>
    </div>
</div>

        
    </div>

    
    </div>
    <
   

<div id="viewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; overflow-y:auto;">
    <div style="background:#111; margin:5% auto; padding:25px; border:2px solid var(--gold); max-width:700px; border-radius:12px; position:relative;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px;">
            <h1 style="color:var(--gold); margin:0; font-size:1.2rem;">INSTITUTIONAL DEEP-DIVE</h1>
            <button onclick="closeModal()" style="background:var(--danger); width:35px; color:#fff; cursor:pointer;">X</button>
        </div>
        <div id="modalData" style="margin-top:20px; line-height:1.8;"></div>
    </div>
</div>
       

    <div class="card">
        <h2>System Reset</h2>
        <select id="resetTarget" style="width:200px;"><option value="A">Acc A</option><option value="B">Acc B</option><option value="C">Acc C</option><option value="D">Acc D</option><option value="E">Acc E</option></select>
        <button onclick="handleResetBalance()" style="background:#333; width:150px;">Reset Account</button>
    </div>
</div>

<div id="viewModal" class="modal">
    <div class="modal-content">
        <button onclick="closeModal()" style="position:absolute; right:15px; top:15px; width:40px; background:var(--danger);">X</button>
        <h1 style="color:var(--gold); margin-top:0;">INSTITUTIONAL TRADE DEEP-DIVE</h1>
        <hr border="1" color="#222">
        <div id="modalData" style="line-height:1.6; margin-top:20px;"></div>
    </div>
</div>

<script>
    const PASS = "Akanksha@2011";
    const config = { A:10000, B:25000, C:50000, D:25000, E:50000 };
    const risks = { A:0.0035, B:0.0035, C:0.0035, D:0.005, E:0.006 };
    
    let db = JSON.parse(localStorage.getItem("aaravDB_v16")) || {};
    let history = JSON.parse(localStorage.getItem("aaravHist_v16")) || [];
    let equityPoints = JSON.parse(localStorage.getItem("aaravEquity_v16")) || [160000];
    let currentAcc = "";
    let currentVios = [];
    let chartInstance = null;

    function initDB() {
        Object.keys(config).forEach(k => { if(!db[k]) db[k] = { bal: config[k], trades: 0, wins: 0, net: 0 }; });
        renderAll();
    }

    // ORIGINAL BIAS ENGINE LOGIC
    document.querySelectorAll(".perm").forEach(el => el.addEventListener("change", () => {
        let s=document.getElementById("support").checked, d=document.getElementById("demand").checked, dis=document.getElementById("discount").checked;
        let r=document.getElementById("resistance").checked, su=document.getElementById("supply").checked, p=document.getElementById("premium").checked;
        let box = document.getElementById("biasDisplay");
        if((s||d) && dis) { box.innerText="INSTITUTIONAL BULLISH BIAS"; box.style.background="#1b5e20"; }
        else if((r||su) && p) { box.innerText="INSTITUTIONAL BEARISH BIAS"; box.style.background="#b71c1c"; }
        else { box.innerText="NEUTRAL BIAS"; box.style.background="#111"; }
    }));

    function addVio() {
        let v = document.getElementById("vSelect").value;
        if(v !== "None" && !currentVios.includes(v)) {
            currentVios.push(v);
            document.getElementById("vListDisplay").innerHTML += `<span class="vio-tag">${v}</span>`;
        }
    }

    function renderAll() {
        localStorage.setItem("aaravDB_v16", JSON.stringify(db));
        localStorage.setItem("aaravHist_v16", JSON.stringify(history));
        localStorage.setItem("aaravEquity_v16", JSON.stringify(equityPoints));
        
        const display = document.getElementById("balanceDisplay");
        const portal = document.getElementById("portalBody");
        const foot = document.getElementById("portalFoot");
        display.innerHTML = ""; portal.innerHTML = "";
        
        let tT=0, tW=0, tN=0, tB=0;
        Object.keys(db).forEach(k => {
            display.innerHTML += `<div class="balance-chip">${k}: <b>$${db[k].bal.toFixed(2)}</b></div>`;
            let wr = db[k].trades ? ((db[k].wins/db[k].trades)*100).toFixed(1) : 0;
            portal.innerHTML += `<tr><td>Acc ${k}</td><td>${db[k].trades}</td><td>${db[k].wins}</td><td>$${db[k].net.toFixed(2)}</td><td>${wr}%</td><td>$${db[k].bal.toFixed(2)}</td></tr>`;
            tT += db[k].trades; tW += db[k].wins; tN += db[k].net; tB += db[k].bal;
        });

        foot.innerHTML = `<tr><td>TOTAL</td><td>${tT}</td><td>${tW}</td><td>$${tN.toFixed(2)}</td><td>${tT ? (tW/tT*100).toFixed(1) : 0}%</td><td>$${tB.toFixed(2)}</td></tr>`;
        filterHistory();
        updateChart();
    }

    let chartRange = 7; 

function changeChartRange(days) {
    chartRange = days;
    updateChart();
}

function updateChart() {
    const ctx = document.getElementById('equityLineChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    const displayData = equityPoints.slice(-chartRange);
    const labels = displayData.map((_, i) => `T-${displayData.length - 1 - i}`);

    // Inside Win-Rate Calculation
    const totalTrades = Object.values(db).reduce((s, a) => s + a.trades, 0);
    const totalWins = Object.values(db).reduce((s, a) => s + a.wins, 0);
    const wr = totalTrades ? ((totalWins / totalTrades) * 100).toFixed(1) : 0;
    document.getElementById('chartWR').innerText = wr + "%";

    // Multi-Segment Color Logic
    const segmentColors = [];
    for (let i = 0; i < displayData.length; i++) {
        // Hum history se pichle trades ka outcome nikalenge
        let tradeIndex = (history.length - (displayData.length - 1)) + i;
        let trade = history[tradeIndex];
        
        if (trade) {
            let scales = trade.scale || [];
            if (trade.type === "Stop Loss") {
                segmentColors.push('#d32f2f'); // Red Line
            } else if (scales.includes("1:3 (30%)") || scales.includes("Runner (30%)")) {
                segmentColors.push('#00ff41'); // Advanced Green
            } else {
                segmentColors.push('#c5a059'); // Gold Line (Default 1:2)
            }
        } else {
            segmentColors.push('#c5a059'); 
        }
    }

    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: displayData,
                // Multi-color line configuration
                segment: {
                    borderColor: (ctx) => segmentColors[ctx.p0DataIndex] || '#c5a059'
                },
                borderWidth: 1.5, // Patli line (Thin)
                pointRadius: 3,
                pointBackgroundColor: (ctx) => segmentColors[ctx.dataIndex] || '#c5a059',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    grid: { color: 'rgba(255,255,255,0.03)' },
                    ticks: { color: '#444', font: { size: 10 } }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#444', font: { size: 10 } }
                }
            }
        }
    });
}

    function updateAccount() {
        let day = document.getElementById("daySelect").value;
        let slot = document.getElementById("slotSelect").value;
        let direct = document.getElementById("directAccount").value;
        if(direct) currentAcc = direct;
        else if(day && slot) {
            const map = { Monday:["A","C"], Tuesday:["B","A"], Wednesday:["C","B"], Thursday:["A","B"], Friday:["B","C"] };
            currentAcc = map[day][slot-1];
        }
        if(currentAcc) {
            let rAmt = db[currentAcc].bal * risks[currentAcc];
            document.getElementById("accountInfo").innerHTML = `<b>ACTIVE: ACC ${currentAcc}</b> | Risk: $${rAmt.toFixed(2)}`;
        }
    }

    document.querySelectorAll(".flow, #riskQty").forEach(el => el.addEventListener("change", () => {
        const checks = Array.from(document.querySelectorAll(".flow"));
        const allChecked = checks.every(i => i.checked);
        document.getElementById("executeBtn").disabled = !(allChecked && document.getElementById("riskQty").value);
    }));

    function revealSections() { document.getElementById("postTradeSections").style.display = "block"; }

    function handleSaveAction() {
        if(document.getElementById("sysPass").value !== PASS) return alert("Wrong Password!");
        let pl = parseFloat(document.getElementById("netPL").value) || 0;
        let out = document.getElementById("outcome").value;

        // Validation for Shutdown Protocol
        if (!document.getElementById("checkPositions").checked || !document.getElementById("checkMT5").checked || 
            !document.getElementById("checkApp").checked || !document.getElementById("checkLaptop").checked) {
            return alert("All Shutdown Protocol steps must be completed!");
        }

        db[currentAcc].trades += 1;
        if(out === "Target") db[currentAcc].wins += 1;
        let finalPL = (out==="Stop Loss" ? -Math.abs(pl) : pl);
        db[currentAcc].net += finalPL;
        db[currentAcc].bal += finalPL;

        // Image Handling
        const fileInput = document.getElementById('screenshotInput');
        const file = fileInput.files[0];
        let base64Image = '';

        if (file) {
            const reader = new FileReader();
            reader.onloadend = function() {
                base64Image = reader.result;
                history.push({
                    date: document.getElementById("tradeDate").value,
                    acc: currentAcc,
                    type: out, pl: finalPL,
                    entry: document.getElementById("entryPrice").value,
                    exit: document.getElementById("exitPrice").value,
                    asset: document.getElementById("assetSelect").value,
                    grade: document.getElementById("gradeSelect").value,
                    vios: [...currentVios],
                    psy: [document.getElementById("psy1").value, document.getElementById("psy2").value, document.getElementById("psy3").value, document.getElementById("psy4").value, document.getElementById("psy5").value, document.getElementById("lesson").value],
                    scale: Array.from(document.querySelectorAll(".scale:checked")).map(c => c.value),
                    image: base64Image // Storing Full-resolution image as base64
                });

                equityPoints.push(Object.values(db).reduce((s, a) => s + a.bal, 0));
                renderAll();
                downloadSinglePDF(history[history.length - 1]); // Generate and download individual PDF with image
                alert("Institutional Session Locked!");
                location.reload();
            };
            reader.readAsDataURL(file); // Reads image as a base64 string
        } else {
            return alert("Please upload a trade screenshot!");
        }
    }

    // --- ADVANCED HISTORY & MODAL LOGIC (Existing Filter/Delete) ---
    function filterHistory() {
        const from = document.getElementById("histFrom").value;
        const to = document.getElementById("histTo").value;
        const body = document.getElementById("historyBody");
        body.innerHTML = "";

        let filteredData = history.filter(h => {
            if (!from && !to) return true;
            return (!from || h.date >= from) && (!to || h.date <= to);
        });

        // Default 4 trades, filter lagne par all
        let finalDisplay = (from || to) ? filteredData : filteredData.slice(-4);

        finalDisplay.slice().reverse().forEach((h) => {
            let originalIdx = history.indexOf(h); 
            body.innerHTML += `<tr>
                <td>${h.date}</td><td>${h.acc}</td>
                <td style="color:${h.type==='Target'?'#00ff41':'#ff3131'}">${h.type}</td>
                <td>$${h.pl}</td><td>${h.grade}</td>
                <td>
                    <button class="view-btn" onclick="viewDeepDive(${originalIdx})">VIEW</button>
                    <button class="del-btn" onclick="deleteTrade(${originalIdx})">DEL</button>
                </td></tr>`;
        });
    }

    // --- PDF GENERATION WITH IMAGE LOGIC ---
    function downloadSinglePDF(t) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16); doc.text("INSTITUTIONAL TRADE REPORT", 14, 20);
        doc.setFontSize(10);
        
        const data = [
            ["Date", t.date], ["Account", t.acc], ["Asset", t.asset], ["Outcome", t.type],
            ["Net P/L", `$${t.pl.toFixed(2)}`], ["Entry Price", t.entry], ["Exit Price", t.exit],
            ["Grade", t.grade], ["Scales Booked", t.scale.join(", ")],
            ["Violations", t.vios.join(", ")],
            ["Plan vs Emotion", t.psy[0]], ["Setup", t.psy[1]], ["Patience", t.psy[2]],
            ["Focus", t.psy[3]], ["Bias", t.psy[4]], ["Lesson", t.psy[5]]
        ];
        
        doc.autoTable({ startY: 30, body: data, theme: 'grid' });

        // Add Image if available
        if (t.image) {
            doc.addPage(); // Add a new page for the image
            doc.text("TRADE SCREENSHOT", 14, 15);
            const format = t.image.includes('png') ? 'PNG' : 'JPEG';
        doc.addImage(t.image, format, 15, 20, 180, 135); // Add base64 image
        }
        
        doc.save(`Trade_${t.date}_${t.acc}.pdf`);
    }

    function deleteTrade(idx) {
        if(document.getElementById("sysPass").value !== PASS) return alert("SECURITY: Wrong Password!");
        if(confirm("Permanently delete this record?")) {
            let t = history[idx];
            db[t.acc].trades--; if(t.type==="Target") db[t.acc].wins--;
            db[t.acc].bal -= t.pl; db[t.acc].net -= t.pl;
            history.splice(idx, 1); equityPoints.pop();
            renderAll();
        }
    }

    function downloadHistoryPDF() {
        // ... (Keep existing downloadHistoryPDF logic)
    }

    function closeModal() { document.getElementById("viewModal").style.display = "none"; }
    function viewDeepDive(idx) {
        let t = history[idx];
        document.getElementById("modalData").innerHTML = `
            <div class="grid">
                <div><b>Date:</b> ${t.date}</div><div><b>Acc:</b> ${t.acc}</div>
                <div><b>Asset:</b> ${t.asset}</div><div><b>PL:</b> $${t.pl}</div>
                <div><b>Scales:</b> ${t.scale.join(", ") || "None"}</div>
            </div>
            <div style="margin-top:20px;"><b>Violations:</b><br>${t.vios.map(v=>`<span class="vio-tag">${v}</span>`).join("") || "None"}</div>
            <div style="margin-top:20px; background:#1a1a1a; padding:15px; border-radius:8px;">
                <p><b>Plan vs Emotion:</b> ${t.psy[0]}</p><p><b>Institutional Setup:</b> ${t.psy[1]}</p>
                <p><b>Master Lesson:</b> ${t.psy[5]}</p>
            </div>
        `;
        document.getElementById("viewModal").style.display = "block";
    }

    function handleResetBalance() {
        if(document.getElementById("sysPass").value !== PASS) return alert("Wrong Password!");
        let t = document.getElementById("resetTarget").value;
        db[t] = { bal: config[t], trades: 0, wins: 0, net: 0 };
        renderAll();
    }
    (function startProfessionalInstitutionalRadar() {
    function updateRadarSystem() {
        const now = new Date();
        const month = now.getMonth() + 1;
        const day = now.getDay(); // 0: Sun, 6: Sat, 1: Mon
        
        // 1. DST LOGIC (March to Nov: 7:30 PM | Nov to March: 8:30 PM)
        const isDST = (month > 3 && month < 11);
        const startH = isDST ? 19 : 20;
        const startM = 30;

        const config = [
            { id: 'timerT1', card: 'cardT1', sOff: 0, eOff: 30, color: '#00d4ff' },
            { id: 'timerT2', card: 'cardT2', sOff: 45, eOff: 60, color: '#bc13fe' }
        ];

        config.forEach(w => {
            const timerEl = document.getElementById(w.id);
            const cardEl = document.getElementById(w.card);
            if (!timerEl || !cardEl) return;

            // Aaj ki expected window times
            let sTime = new Date(); sTime.setHours(startH, startM + w.sOff, 0, 0);
            let eTime = new Date(); eTime.setHours(startH, startM + w.eOff, 0, 0);

            // 2. LOGIC: Check if we are LIVE right now
            // Weekend par Live nahi ho sakta
            const isWeekend = (day === 0 || day === 6);
            
            if (!isWeekend && now >= sTime && now <= eTime) {
                // --- LIVE STATE ---
                let left = Math.floor((eTime - now) / 1000);
                let mins = Math.floor(left / 60);
                let secs = left % 60;
                timerEl.innerHTML = `<span style="color:#00ff41">‚óè LIVE: ${mins}m ${secs}s</span>`;
                cardEl.style.borderColor = "#00ff41";
                cardEl.style.boxShadow = "0 0 20px rgba(0, 255, 65, 0.4)";
                cardEl.style.background = "rgba(0, 255, 65, 0.05)";
            } 
            else {
                // --- COUNTDOWN / EXPIRED LOGIC ---
                let target = new Date(sTime);

                // Agar aaj ka time nikal gaya hai YA aaj weekend hai, toh next valid day dhundo
                if (now > eTime || isWeekend) {
                    // Agle din se check shuru karo agar aaj ka session khatam
                    if (now > eTime) target.setDate(target.getDate() + 1);
                    
                    // Jab tak Saturday ya Sunday mile, skip karke agla din check karo (Monday tak)
                    while (target.getDay() === 0 || target.getDay() === 6) {
                        target.setDate(target.getDate() + 1);
                    }
                }

                let diff = target - now;
                let h = Math.floor(diff / 3600000);
                let m = Math.floor((diff % 3600000) / 60000);
                let s = Math.floor((diff % 60000) / 1000);

                // UI Update based on State
                if (now > eTime && !isWeekend) {
                    // Aaj ka session khatam (RED)
                    timerEl.innerHTML = `<span style="color:#ff5252">EXPIRED | Next in ${h}h ${m}m</span>`;
                    cardEl.style.borderColor = "#ff5252";
                    cardEl.style.background = "#000";
                    cardEl.style.boxShadow = "none";
                } else {
                    // Waiting for Next (Original Colors)
                    timerEl.style.color = "#fff";
                    timerEl.textContent = `${h}h ${m}m ${s}s`;
                    cardEl.style.borderColor = w.color;
                    cardEl.style.background = "#000";
                    cardEl.style.boxShadow = "0 4px 15px rgba(0,0,0,0.5)";
                }
            }
        });
    }

    // Har 1 second mein update karo
    setInterval(updateRadarSystem, 1000);
    updateRadarSystem();
})();

// 3. QUANTITY CALCULATION & AUTHORIZE BUTTON FIX
function updateAccount() {
    let asset = document.getElementById("assetSelect").value;
    let daySelect = document.getElementById("daySelect").value;
    let slotSelect = document.getElementById("slotSelect").value;
    let direct = document.getElementById("directAccount").value;
    
    // Account Selection Logic
    if(direct) currentAcc = direct;
    else if(daySelect && slotSelect) {
        const map = { 
            Monday:["A","C"], Tuesday:["B","A"], Wednesday:["C","B"], 
            Thursday:["A","B"], Friday:["B","C"] 
        };
        currentAcc = map[daySelect][slotSelect-1];
    }

    if(currentAcc) {
        let rAmt = db[currentAcc].bal * risks[currentAcc]; 
        let qtyBox = document.getElementById("riskQty");

        if(asset === "XAUUSD") {
            // Gold Logic: $35 risk / $2.5 to $7 range
            let minLot = ((rAmt / 7) * 0.01).toFixed(2);
            let maxLot = ((rAmt / 2.5) * 0.01).toFixed(2);
            
            // Input box mein range fill karo
            qtyBox.value = `${minLot} - ${maxLot}`;
            
            document.getElementById("accountInfo").innerHTML = `
                <div style="display:flex; justify-content:space-between; color:var(--gold);">
                    <span>ACC: ${currentAcc}</span>
                    <span>RISK: $${rAmt.toFixed(2)}</span>
                </div>
                <div style="margin-top:5px; font-size:0.8rem; color:#fff;">
                    Suggested: ${minLot} to ${maxLot} Lots
                </div>
            `;
        }
    }
    checkExecutionReady(); // Button status refresh karo
}

// 4. AUTHORIZE BUTTON UNLOCK LOGIC
function checkExecutionReady() {
    const checks = Array.from(document.querySelectorAll(".flow"));
    const allChecked = checks.every(i => i.checked);
    const hasQty = document.getElementById("riskQty").value !== "";
    const btn = document.getElementById("executeBtn");
    
    // Agar sab tick hai aur qty hai, toh button enable (Currently bypass session lock for demo)
    btn.disabled = !(allChecked && hasQty);
}

// Checkboxes par event listener lagao
document.querySelectorAll(".flow").forEach(el => el.addEventListener("change", checkExecutionReady));
(function startUltraRadar() {
    function update() {
        const now = new Date();
        const month = now.getMonth() + 1;
        const isDST = (month > 3 && month < 11);
        const startH = isDST ? 19 : 20;
        const startM = 30;

        const config = [
            { id: 'timerT1', card: 'cardT1', sOff: 0, eOff: 30, color: '#00d4ff', shadow: 'rgba(0, 212, 255, 0.5)' },
            { id: 'timerT2', card: 'cardT2', sOff: 45, eOff: 60, color: '#bc13fe', shadow: 'rgba(188, 19, 254, 0.5)' }
        ];

        config.forEach(w => {
            const timerEl = document.getElementById(w.id);
            const cardEl = document.getElementById(w.card);

            let sTime = new Date(); sTime.setHours(startH, startM + w.sOff, 0, 0);
            let eTime = new Date(); eTime.setHours(startH, startM + w.eOff, 0, 0);

            if (now >= sTime && now <= eTime && now.getDay() !== 0 && now.getDay() !== 6) {
                // --- LIVE STATE (BRIGHT GREEN GLOW) ---
                let left = Math.floor((eTime - now) / 1000);
                timerEl.innerHTML = `<span style="color:#00ff41; text-shadow: 0 0 15px #00ff41;">‚óè LIVE: ${Math.floor(left/60)}m ${left%60}s</span>`;
                cardEl.style.borderColor = "#00ff41";
                cardEl.style.boxShadow = "0 0 30px rgba(0, 255, 65, 0.6)";
                cardEl.style.background = "rgba(0, 255, 65, 0.1)";
            } 
            else {
                // --- COUNTDOWN / EXPIRED LOGIC ---
                let target = new Date(sTime);
                if (now > eTime || now.getDay() === 0 || now.getDay() === 6) {
                    if (now > eTime) target.setDate(target.getDate() + 1);
                    while (target.getDay() === 0 || target.getDay() === 6) target.setDate(target.getDate() + 1);
                }

                let diff = target - now;
                let h = Math.floor(diff / 3600000);
                let m = Math.floor((diff % 3600000) / 60000);
                let s = Math.floor((diff % 60000) / 1000);

                if (now > eTime && now.getDay() !== 0 && now.getDay() !== 6) {
                    // --- EXPIRED (BLOOD RED) ---
                    timerEl.style.color = "#ff5252";
                    timerEl.textContent = `EXPIRED | ${h}h ${m}m`;
                    cardEl.style.borderColor = "#ff5252";
                    cardEl.style.boxShadow = "0 0 20px rgba(255, 82, 82, 0.3)";
                    cardEl.style.background = "rgba(255, 82, 82, 0.05)";
                } else {
                    // --- WAITING (PRO NEON COLORS) ---
                    timerEl.style.color = "#fff";
                    timerEl.textContent = `${h}h ${m}m ${s}s`;
                    cardEl.style.borderColor = w.color;
                    cardEl.style.boxShadow = `0 0 20px ${w.shadow}`;
                    cardEl.style.background = "#0a0a0a";
                }
            }
        });
    }
    setInterval(update, 1000);
    update();
})();
// Global states for checklist
const flowKeys = ["Sleep", "No Revenge", "Desk Ready", "HTF Location", "Single Side", "No Mid-Range", "Clear Range", "LTF Confirm"];
let flowMemory = {}; 

function initFlowUI() {
    const container = document.getElementById("binaryChecklist");
    if(!container) return;
    container.innerHTML = "";
    flowKeys.forEach(key => {
        const div = document.createElement("div");
        div.className = "bin-item";
        div.innerHTML = `
            <span class="bin-text">${key}</span>
            <div style="display:flex; gap:5px;">
                <button type="button" class="t-btn g-off ${flowMemory[key]==='G'?'g-on':''}" onclick="setFlowState('${key}','G')">G</button>
                <button type="button" class="t-btn r-off ${flowMemory[key]==='R'?'r-on':''}" onclick="setFlowState('${key}','R')">R</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function setFlowState(key, val) {
    flowMemory[key] = val;
    initFlowUI();
    updateFlowStatus();
}

function updateFlowStatus() {
    const greens = Object.values(flowMemory).filter(v => v === 'G').length;
    const qty = document.getElementById("riskQty").value.trim();
    const liq = document.getElementById("liqType").value;
    
    const card = document.getElementById("flowCard");
    const title = document.getElementById("flowTitle");
    const btn = document.getElementById("executeBtn");

    // Condition: Risk aur Liquidity bharna hi padega
    const isMandatoryDone = (qty !== "" && liq !== "");

    if (greens >= 7 && isMandatoryDone) {
        // --- GREEN STATUS (TRADE 2 STYLE) ---
        card.className = "card exec-card-ready";
        title.style.color = "#00ff41";
        btn.disabled = false;
        btn.style.background = "#00ff41";
        btn.style.color = "#000";
        btn.innerText = "AUTHORIZE ENTRY (READY)";
        btn.style.cursor = "pointer";
    } else {
        // --- RED/DEFAULT STATUS ---
        card.className = "card exec-card-locked";
        title.style.color = "#ff5252";
        btn.disabled = true;
        btn.style.background = "#1a1a1a";
        btn.style.color = "#444";
        btn.innerText = isMandatoryDone ? `LOCKED (${greens}/7 GREEN)` : "LOCKED (FILL MANDATORY)";
        btn.style.cursor = "not-allowed";
    }
}

// Initial Call
initFlowUI();
    initDB();
</script>

<!-- ===== MASTER VIEW + COMPLETE PDF INTEGRATION (UI UNCHANGED) ===== -->
<script>
(function(){

function waitForTradeObject(callback){
    let check = setInterval(()=>{
        if(typeof history !== "undefined" && history.length > 0){
            clearInterval(check);
            callback(history[history.length-1]);
        }
    },300);
}

function buildMasterDownloadButton(tradeData){

    if(document.getElementById("masterDownloadBtn")) return;

    const btn = document.createElement("button");
    btn.id = "masterDownloadBtn";
    btn.innerText = "DOWNLOAD COMPLETE MASTER SESSION PDF";
    btn.style.marginTop = "40px";
    btn.style.padding = "15px";
    btn.style.fontWeight = "bold";
    btn.style.background = "gold";
    btn.style.color = "#000";
    btn.style.width = "100%";
    btn.onclick = function(){
        generateMasterPDF(tradeData);
    };

    document.body.appendChild(btn);
}

window.generateMasterPDF = function(t){

    const {jsPDF} = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("INSTITUTIONAL MASTER SESSION REPORT",20,20);

    doc.setFontSize(10);
    let y = 35;

    function addLine(text){
        doc.text(text,20,y);
        y+=7;
        if(y>270){ doc.addPage(); y=20; }
    }

    addLine("Trading Control Panel");
    addLine("----------------------");

    for(let key in t){
        if(key !== "htf" && key !== "ltf"){
            let value = Array.isArray(t[key]) ? t[key].join(" | ") : t[key];
            addLine(key + " : " + value);
        }
    }

    if(t.htf && t.ltf){
        doc.addPage();
        doc.text("HTF & LTF Screenshots",20,20);
        doc.addImage(t.htf,"JPEG",15,30,180,90);
        doc.addImage(t.ltf,"JPEG",15,130,180,90);
    }

    doc.save("Institutional_Master_Full_Session.pdf");
};

// Hook into existing LOCK function safely
if(typeof window.handleSaveAction === "function"){
    const original = window.handleSaveAction;

    window.handleSaveAction = function(){
        original.apply(this, arguments);

        setTimeout(()=>{
            waitForTradeObject((lastTrade)=>{
                if(lastTrade){
                    buildMasterDownloadButton(lastTrade);
                }
            });
        },500);
    };
}

})();
</script>

</body>
</html>
</script>

<!-- ===== MASTER VIEW + COMPLETE PDF INTEGRATION (UI UNCHANGED) ===== -->
<script>
(function(){

function waitForTradeObject(callback){
    let check = setInterval(()=>{
        if(typeof history !== "undefined" && history.length > 0){
            clearInterval(check);
            callback(history[history.length-1]);
        }
    },300);
}

function buildMasterDownloadButton(tradeData){

    if(document.getElementById("masterDownloadBtn")) return;

    const btn = document.createElement("button");
    btn.id = "masterDownloadBtn";
    btn.innerText = "DOWNLOAD COMPLETE MASTER SESSION PDF";
    btn.style.marginTop = "40px";
    btn.style.padding = "15px";
    btn.style.fontWeight = "bold";
    btn.style.background = "gold";
    btn.style.color = "#000";
    btn.style.width = "100%";
    btn.onclick = function(){
        generateMasterPDF(tradeData);
    };

    document.body.appendChild(btn);
}

window.generateMasterPDF = function(t){

    const {jsPDF} = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("INSTITUTIONAL MASTER SESSION REPORT",20,20);

    doc.setFontSize(10);
    let y = 35;

    function addLine(text){
        doc.text(text,20,y);
        y+=7;
        if(y>270){ doc.addPage(); y=20; }
    }

    addLine("Trading Control Panel");
    addLine("----------------------");

    for(let key in t){
        if(key !== "htf" && key !== "ltf"){
            let value = Array.isArray(t[key]) ? t[key].join(" | ") : t[key];
            addLine(key + " : " + value);
        }
    }

    if(t.htf && t.ltf){
        doc.addPage();
        doc.text("HTF & LTF Screenshots",20,20);
        doc.addImage(t.htf,"JPEG",15,30,180,90);
        doc.addImage(t.ltf,"JPEG",15,130,180,90);
    }

    doc.save("Institutional_Master_Full_Session.pdf");
};

// Hook into existing LOCK function safely
if(typeof window.handleSaveAction === "function"){
    const original = window.handleSaveAction;

    window.handleSaveAction = function(){
        original.apply(this, arguments);

        setTimeout(()=>{
            waitForTradeObject((lastTrade)=>{
                if(lastTrade){
                    buildMasterDownloadButton(lastTrade);
                }
            });
        },500);
    };
}

})();
</script>

</body>
</html>